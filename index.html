<html>

    <head>
        <title>Telnet client using websockify</title>
        <script src="components/jquery/jquery.js"></script>
        <script src="proxy/client/util.js"></script>
        <script src="proxy/client/base64.js"></script>
        <script src="proxy/client/websock.js"></script>
        <script src="websocketTelnet.js"></script>

        <link href="boilerplate.css" rel='stylesheet' type='text/css'>
        <link href='http://fonts.googleapis.com/css?family=Anonymous+Pro' rel='stylesheet' type='text/css'>
        <link href="telnet.css" type="text/css" rel="Stylesheet" />

    </head>

    <body>


        <div id="telnetTest" class="telnetContainer">

        </div>


        <script type="text/javascript">



            var target = $('#telnetTest');

            var data = {
                    currentLength: 0,
                    output: $('<pre class="telnet fg bg">'),
                    maxScrollback:2000,
                    commandBar: $('<div class="commandBar"></div>'),
                    target: target,
                    input: $('<input type="text" />'),
                    commandHistory:  [],
                    commandHistoryPos: 0,
                    telnet: new Telnet()
                };


            data.output.appendTo(data.target);
            data.input
                .appendTo(data.target)
                .addClass('inText')
                .on('keyup', function(evt){
                    // preserve context with call
                    keypress.call(this,evt);
                })
            ;

            target.data('telnet', data);

            resize(data);

            // auto login...
            data.telnet.on('parse_prompt', function(prompt) {
                if (prompt.match(/Choice:/)) {
                    data.telnet.sendText('TestUnit');
                }
                if (prompt.match(/Password:/)) {
                    data.telnet.sendText('TestPassword');
                }
            });


            data.telnet.on('add_line',function(text) {
                data.output.append('\n' + text );
                data.currentLength += text.length;

                // if we've passed the max scroll back remove the overflow + 20%
                if (data.currentLength > data.maxScrollback ) {
                    var rawhtml = data.output.html();
                    var newstart = rawhtml.indexOf('\n', data.currentLength - data.maxScrollback + Math.ceil(data.maxScrollback * 0.2) );
                    rawhtml = rawhtml.substr(newstart + 1);
                    data.currentLength = rawhtml.length;
                    data.output.html(rawhtml);
                }

                data.output.scrollTop(data.output.prop("scrollHeight"));
            });

            data.telnet.on('append_line', function(text) {

                data.currentLength += text.length;

                data.output.append( text );
            });

            data.telnet.on('reset', function() {
                data.output.empty();
                data.currentLength = 0;
            });

            data.telnet.on('log', function(text) {
                if(window.console){
                    console.log( text );
                }
            });


            data.telnet.open({host:'vault-thirteen.net', port:8000});


            function resize(data) {
                data.output.outerHeight(data.target.outerHeight() - data.input.outerHeight() - data.commandBar.outerHeight());
            }

            function keypress(event) {

                switch (event.which) {
                    // enter
                case 13:
                    event.preventDefault();
                    var $this = $(this).parent();
                    var data = $this.data('telnet');
                    var cmd = data.input.val();

                    // if this command came from the history don't add it to the history
                    if (data.commandHistoryPos === 0 || data.commandHistory[data.commandHistory.length - data.commandHistoryPos] !== cmd ){
                        data.commandHistory.push(cmd);
                    }

                    data.commandHistoryPos = 0;


                    if (data.commandHistory.length > data.commandHistoryLength) {
                        data.commandHistory = data.commandHistory.slice(1);
                    }

                    // calling sendText so we can pass the correct context (i.e this->parent)
                    data.telnet.sendText(cmd);
                    console.log(cmd);
                    data.input.val('');
                    break;

                // up
                // down
                case 38:
                case 40:
                    var data = $(this).parent().data('telnet');
                    var cmd = "";
                    // don't go below zero (i.e if they go down from 0, and if they go up from max reset to 0)
                    data.commandHistoryPos = Math.max(0,(data.commandHistoryPos + (39 - event.which) )) % (data.commandHistory.length + 1);
                    if (data.commandHistoryPos) {
                        cmd = data.commandHistory[data.commandHistory.length - data.commandHistoryPos];
                    }
                    data.input.val(cmd);
                    break;

                default:
                        // no-op atm

                }

            }

        </script>

    </body>

</html>