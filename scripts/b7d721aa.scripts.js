"use strict";angular.module("clientApp",["templates-main"]).config(["$routeProvider",function(e){e.when("/",{templateUrl:"views/main.html"}).when("/about",{templateUrl:"views/about.html"}).when("/contact",{templateUrl:"views/contact.html"}).otherwise({redirectTo:"/"})}]),angular.module("clientApp").controller("MainCtrl",["$scope","$rootScope","$window","telnet","$timeout",function(e,t,n,r,i){t.windowHeight=n.innerHeight,t.telnetScope=r.getScope(),t.telnet=r,angular.element(n).bind("resize",function(){t.windowHeight!==n.innerHeight&&(t.windowHeight=n.innerHeight,i(function(){t.$apply("windowHeight")},0))}),r.connect("vault-thirteen.net",8e3)}]),angular.module("clientApp").controller("ScanCtrl",["$scope","autoscan","telnet","keypress",function(e,t,n,r){e.autoscanScope=t.getScope(),e.autoscan=t;var i=function(e){switch(e){case"up":return"north";case"tilde":return"here";case"down":return"south";case"left":return"west";case"right":return"east";case"pageup":return"up";case"pagedown":return"down";case"tab":return"refresh"}return""};r.$scope.$on(r.events.keydown,function(o,a){var s=r.getEventKey(a),u=i(s);if(""!==u)e.directionClick(u);else if(""!==e.autoscanScope.selectedDirection&&"number"==typeof s&&(s--,u=e.autoscanScope.selectedDirection,t.directionExists()&&t.$scope.adjacentRooms[u].buttons.length>s)){var c=t.$scope.adjacentRooms[u].buttons[s];n.send(c.command)}}),e.directionClick=function(t){"refresh"===t?(n.send("scan"),e.autoscanScope.selectedDirection="",e.autoscanScope.$apply("selectedDirection")):e.autoscanScope.selectedDirection!==t&&e.autoscan.hasButtons(t)?e.autoscanScope.selectedDirection!==t&&(e.autoscanScope.selectedDirection=t,e.autoscanScope.$apply("selectedDirection")):"here"!==t&&n.send(t)}}]),angular.module("clientApp").factory("telnet",["$rootScope","$timeout",function(e,t){var n=e.$new();n.outputBuffer="",n.bConnected=!1,n.maxScrollback=2e4,n.server="",n.port="",n.telnetEvents={parsePrompt:"TELNET_PARSE_PROMPT",parseBlock:"TELNET_PARSE_BLOCK",parseLine:"TELNET_PARSE_LINE",connect:"TELNET_CONNECT",disconnect:"TELNET_DISCONNECT"};var r={};r.ECHO=1,r.LF=10,r.CR=13,r.ESC=27,r.WILL=251,r.WONT=252,r.DO=253,r.DONT=254,r.IAC=255;var i=new Websock,o=0,a="",s=1,u=0,c=!1,l=!1,f=/^(<[^>]*>|\s*Choice:|\s*Password:|--\s*MORE\s*--\s*<[^>]*>|\s*Press <return> to continue\.|\s*Disconnect previous link\?)\s*$/,p=function(e){l&&window.console&&console.log(e)},d=function(){for(var e="";u>0;)e+="</span>",u--;return e},h=function(e,t){return parseInt(e,10)-parseInt(t,10)},m=function(e){if(c?(n.outputBuffer+=e+d(),c=!1):n.outputBuffer+="<br />"+e+d(),n.outputBuffer.length>n.maxScrollback){var r=n.outputBuffer.indexOf("<br />",n.outputBuffer.length-n.maxScrollback+Math.ceil(.2*n.maxScrollback));r>0&&(n.outputBuffer=n.outputBuffer.substr(r+6))}l&&p("buffer: "+e),t(function(){n.$apply("outputBuffer")},0)},g=function(e){for(var t="",l="",g="",v=0;e.length>v;v++){var y=e[v];switch(o){case 0:y===r.IAC?o=1:y===r.ECHO?s=0===s?1:0:y===r.ESC?o=3:y===r.LF?(m(g),l.length>0&&(a+=l+"\n"),l="",g=""):y!==r.CR&&(l+=String.fromCharCode(y),g+=60===y?"&lt;":62===y?"&gt;":String.fromCharCode(y));break;case 1:o=y===r.DO?2:0;break;case 2:i.send([r.IAC,r.WONT,y]),o=0;break;case 3:if("["===String.fromCharCode(y)){t="",o=4;continue}"c"===String.fromCharCode(y)?(d(),n.outputBuffer=""):"M"===String.fromCharCode(y)?p("[Scroll Up]"):"D"===String.fromCharCode(y)?p("[Scroll Down]"):"H"===String.fromCharCode(y)?p("[Set Tab]"):"8"===String.fromCharCode(y)?p("[Restore Cursor & Attrs]"):"7"===String.fromCharCode(y)?p("[Save Cursor & Attrs]"):")"===String.fromCharCode(y)?p("[Font Set G0]"):"("===String.fromCharCode(y)?p("[Font Set G1]"):p("[unknown escape code : "+y+"]"),o=0;break;case 4:if(y>=48&&57>=y||59===y)t+=String.fromCharCode(y);else if("m"===String.fromCharCode(y)){var $=0,b="",x=t.split(";");x.sort(h);for(var w=0;x.length>w;w++){var C=parseInt(x[w],10);0===C&&u>0&&(g+=d()),1===C&&($=8),(2===C||22===C)&&($=0),3===C&&(b+="italic "),4===C&&(b+="uline "),(5===C||6===C)&&(b+="blink "),7===C&&(b="fg8 bg1"),9===C&&(b+="strikethrough "),37>=C&&C>=30&&(b+="fg"+(C-29+$)),47>=C&&C>=40&&(b+="bg"+(C-39+$))}b.length>0&&(g+='<span class="'+b+'">',u++),o=0}else p("[ansi:"+t+String.fromCharCode(y)+"]"),o=0}}if(a.length>0){for(var S=a.split("\n"),T=0;S.length>T;T++)n.$broadcast(n.telnetEvents.parseLine,S[T]);n.$broadcast(n.telnetEvents.parseBlock,a),a=""}""!==g&&(m(g),null!==l.match(f)?(n.$broadcast(n.telnetEvents.parsePrompt,l),c=!1):c=!0)};return i.on("message",function(){g(i.rQshiftBytes(i.rQlen()))}),i.on("open",function(){n.bConnected=!0,c=!1,m('<span class="cmd">Connected to '+n.server+":"+n.port+"</span>"),n.$broadcast(n.telnetEvents.connect)}),i.on("close",function(){n.bConnected=!1,c=!1,m('<span class="cmd">Disconnected...</span>'),n.$broadcast(n.telnetEvents.disconnect)}),i.on("error",function(){c=!1,m('<span class="cmd">Connection error occured...</span>')}),{getScope:function(){return n},send:function(e){c=!0,i.send_string(e+"\n"),s&&m('<span class="cmd">'+e+"</span>"),l&&p("send: "+e)},silentSend:function(e){c=!0,i.send_string(e+"\n")},connect:function(e,t){i.open("ws://"+e+":"+t,["binary","base64"]),n.server=e,n.port=t},disconnect:function(){i.close()},setConsoleOutput:function(e){l=e===!0}}}]),angular.module("clientApp").directive("scanDirection",function(){var e=function(e){switch(e){case"north":return"arrow-up";case"up":return"caret-up";case"east":return"arrow-right";case"south":return"arrow-down";case"down":return"caret-down";case"west":return"arrow-left";case"here":return"bolt";case"refresh":return"refresh"}};return{restrict:"A",replace:!1,scope:!1,link:function(t,n,r){n.addClass("icon-"+e(r.scanDirection)),n.addClass("btn"),"refresh"!==r.scanDirection&&t.autoscan.$scope.$watch("adjacentRooms."+r.scanDirection,function(e){void 0!==e?(n.removeClass("disabled muted btn-danger btn-info"),"mobs"===e.type?n.addClass("btn-danger"):("locked"===e.type||"dark"===e.type)&&n.addClass("btn-info")):(n.removeClass("btn-danger btn-info"),n.addClass("disabled muted"))},!0),n.bind("click",function(){t.directionClick(r.scanDirection)})}}}),angular.module("clientApp").directive("telnetSend",["telnet",function(e){return function(t,n,r){n.bind("click",function(){e.send(r.telnetSend)})}}]),angular.module("clientApp").directive("telnetStatus",["telnet",function(e){return{templateUrl:"templates/telnetStatus.tpl.html",restrict:"E",replace:!0,link:function(t){t.telnetService=e}}}]),angular.module("clientApp").directive("autoscroll",function(){return{restrict:"A",link:function(e,t){var n=!0,r=function(){return Math.max(t[0].scrollHeight,t[0].clientHeight)-t[0].clientHeight};e.$watch("telnetScope.outputBuffer",function(){n&&(t[0].scrollTop=r())}),t.on("scroll",function(){n=r()!==t[0].scrollTop?!1:!0})}}}),angular.module("clientApp").controller("CommandBarCtrl",["$scope","telnet","$timeout","keypress",function(e,t,n,r){e.command="",e.aCommands=[],e.commandPos=0,e.commandMaxLength=50;var i=function(){(0===e.commandPos||e.aCommands[e.aCommands.length-e.commandPos]!==e.command)&&e.aCommands.push(e.command),e.commandPos=0,e.aCommands.length>e.commandMaxLength&&(e.aCommands=e.aCommands.slice(1)),t.send(e.command),e.command="",n(function(){e.$apply("command")},0)},o=function(t){var r=t.keyCode?t.keyCode:t.which;e.commandPos=Math.max(0,e.commandPos+(39-r))%(e.aCommands.length+1),e.command=e.commandPos?e.aCommands[e.aCommands.length-e.commandPos]:"",n(function(){e.$apply("command")},0)};e.keyDown=function(t){var n=t.keyCode?t.keyCode:t.which;switch(n){case 13:t.preventDefault(),i(t);break;case 33:case 34:r.keyDown(t);break;case 38:case 40:t.shiftKey?(t.preventDefault(),o(t)):(t.preventDefault(),r.keyDown(t));break;case 9:t.preventDefault(),r.keyDown(t);break;default:""===e.command&&(n>=48&&57>=n||192===n||37===n||39===n)&&(t.preventDefault(),r.keyDown(t))}}}]),angular.module("clientApp").directive("commandBar",function(){return{template:'<input ng-controller="CommandBarCtrl" ng-model="command" type="text" class="pull-bottom" style="width:100%">',restrict:"E",replace:!0,link:function(e,t){t.off("keydown").bind("keydown",function(t){e.keyDown(t)}),t[0].focus();var n=!0;t.bind("blur",function(){n=!1}),t.bind("focus",function(){n=!0}),$(window).off("keydown").on("keydown",function(e){n||-1!==$.inArray(document.activeElement.tagName.toLowerCase(),["input","textarea"])||(t[0].focus(),t.trigger(e),console.log("redirected focus"))})}}}),angular.module("clientApp").controller("CommandButtonsCtrl",["$scope","autoscan","keypress","telnet",function(e,t,n,r){e.autoscanScope=t.getScope(),e.aUserCommands=["cast fireball","cast lightning bolt","cast prismatic missile","cast acid blast","cast burning hands","cast mists of sleep","cast freeze","cast maelstrom","cast web","cast slow","cast proble","prep prismatic missile","prep maelstrom"],n.$scope.$on(n.events.keydown,function(t,i){if(""===e.autoscanScope.selectedDirection){var o=n.getEventKey(i);"number"==typeof o&&(o--,-1===o&&(o=9),r.send(e.aUserCommands[o]))}})}]),angular.module("clientApp").factory("autoscan",["$rootScope","telnet","$timeout",function(e,t,n){var r=e.$new();r.selectedDirection="",r.adjacentRooms={};var i=t.getScope(),o=/^(\[Exits:|You see nothing in the vicinity\.)/,a=/,\s+(?=a|an|two|three|four|five|six|seven|eight|nine|ten|[A-Z])/,s=/^\s+(?=a|an|two|three|four|five|six|seven|eight|nine|ten|[A-Z])/,u={n:"north",e:"east",s:"south",w:"west",u:"up",d:"down"},c=!1,l=!1,f={},p="";return i.$on(i.telnetEvents.parseLine,function(e,t){t.match(o)&&(c=!0,f={});var n=t.match(/^\s*\[?(Here|east|west|north|south|up|down)]?\s*:\s*(.*)$/);n?(c=!0,l=!0,p=n[1].toLowerCase(),f[p]=n[2].toLowerCase()):t.match(s)?f[p]+=t:l=!1}),i.$on(i.telnetEvents.parsePrompt,function(e,t){if(c){for(var i in f)if("darkness"===f[i])f[i]={type:"dark",buttons:[{label:"refresh light",command:"refreshLight"}]};else{f[i]=f[i].replace(/^\s*/,"").split(a);for(var o=0;f[i].length>o;o++){var s={label:f[i][o]},p=s.label.replace(/^\s*([^A-Z]\S*)?\s+/,"").replace(/(ves|ies|es|s)\b/g,"").replace(/\s+(the|\w|\w\w)(?=\s+)/g,"").replace(/[^a-zA-Z- ]+/g,"").split(" ").join(".");s.command=("here"!==i?i+" & ":"")+"kill "+p,f[i][o]=s}f[i]={type:"mobs",buttons:f[i]}}var d=t.match(/<.*\s([NESWUD]*)>/i);if(d)for(var h in d[1]){var m=d[1][h].toLowerCase(),g=u[m];f.hasOwnProperty(u[m])||(f[u[m]]=m!==d[1][h]?{type:"empty",buttons:[]}:{type:"locked",buttons:[{label:"open "+g,command:"open "+g+" & scan"},{label:"unlock "+g,command:"unlock "+g+" & scan"},{label:"knock "+g,command:"knock "+g+" & scan"},{label:"pull lever",command:"pull lever & scan"},{label:"pound gate",command:"pound gate & scan"},{label:"move rubble",command:"move rubble & scan"},{label:"open door",command:"open door & scan"},{label:"unlock door",command:"unlock door & scan"},{label:"knock door",command:"knock door & scan"}]})}r.selectedDirection="",r.adjacentRooms=f,f={},l=!1,c=!1,n(function(){r.$apply("adjacentRooms")},0)}}),{directionExists:function(e){return e=e||r.selectedDirection,r.adjacentRooms.hasOwnProperty(e)},hasButtons:function(e){return e=e||r.selectedDirection,r.adjacentRooms.hasOwnProperty(e)&&r.adjacentRooms[e].buttons.length>0},getScope:function(){return r},$scope:r}}]),angular.module("clientApp").factory("keypress",["$rootScope",function(e){var t=e.$new(),n={keydown:"UNHANDLED_KEY_DOWN"};return{keyDown:function(e){t.$broadcast(n.keydown,e)},getEventKey:function(e){var t=e.keyCode?e.keyCode:e.which;switch(t){case 8:return"backspace";case 9:return"tab";case 13:return"enter";case 27:return"esc";case 32:return"space";case 33:return"pageup";case 34:return"pagedown";case 35:return"end";case 36:return"home";case 37:return"left";case 38:return"up";case 39:return"right";case 40:return"down";case 45:return"insert";case 46:return"delete";case 192:return"tilde"}return t>=48&&57>=t?t-48:"unknown"},$scope:t,events:n}}]);