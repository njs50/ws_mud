"use strict";angular.module("clientApp",["templates-main","$strap.directives","ui.bootstrap.modal","ui.bootstrap.dropdownToggle"]).config(["$routeProvider","$locationProvider",function(a,b){b.html5Mode(!1),a.when("/",{templateUrl:"views/main.html"}).when("/about",{templateUrl:"views/about.html"}).when("/map",{templateUrl:"views/map.html"}).when("/contact",{templateUrl:"views/contact.html"}).when("/config/buttons",{templateUrl:"views/editButtons.html"}).otherwise({redirectTo:"/"})}]),angular.module("clientApp").controller("MainCtrl",["$scope","$rootScope","$window","telnet","$timeout","profile","playerStatus","$http","map",function(a,b,c,d,e,f,g,h,i){a.bIsDev="localhost"===$(location).attr("hostname"),b.telnet=d,b.map=i,b.playerStatus=g,h.get("version.json").success(function(a){var c=a.version.split(".");b.version={major:parseInt(c[0],10),minor:parseInt(c[1],10),hash:c[2]}});var j=function(){var a=!1,d=b.windowOrientation;b.windowHeight!==c.innerHeight&&(b.windowHeight=c.innerHeight,a=!0),b.windowWidth!==c.innerWidth&&(b.windowWidth=c.innerWidth,a=!0),b.windowOrientation=b.windowHeight>b.windowWidth||b.windowWidth<940?"portrait":"landscape",d!==b.windowOrientation&&(a=!0),a&&e(function(){b.$digest()},0,!1)};angular.element(c).bind("resize",function(){j()}),j(),g.findName().then(function(){g.updateGroup()}),c.onbeforeunload=function(){return f.save(),!a.bIsDev&&d.$scope.bConnected?"You are currently connected to "+d.$scope.server:void 0};var k=8e3,l="theforestsedge.com";a.bIsDev&&d.$scope.$on(d.$scope.telnetEvents.parseTextPrompt,function(a,b){b.match(/Choice:/)?d.send("Angularo"):b.match(/Password:/)?d.silentSend("Testacularo"):b.match(/Press <return> to continue./)?d.send(""):b.match(/Disconnect previous link?/)&&d.send("y")}),d.connect(l,k)}]),angular.module("clientApp").controller("ScanCtrl",["$scope","autoscan","buttons","keypress","telnet",function(a,b,c,d,e){var f=function(a){switch(a){case"up":return"north";case"tilde":return"here";case"down":return"south";case"left":return"west";case"right":return"east";case"pageup":return"up";case"pagedown":return"down";case"tab":return"refresh";case"esc":return"reset"}return""},g=d.$scope.$on(d.events.keydown,function(b,c){var e=d.getEventKey(c),g=f(e);""!==g&&a.directionClick(g)}),h=b.$scope.$on(b.events.room_changed,function(){c.resetButtons()});a.$on("$destroy",function(){g(),h()}),a.directionClick=function(a){"reset"===a?c.resetButtons():"refresh"===a?(c.resetButtons(),e.send("scan")):c.$scope.buttonSet!==a&&b.hasButtons(a)?c.$scope.buttonSet!==a&&c.setDirectionButtons(a):"here"!==a&&e.send(a)}}]),angular.module("clientApp").factory("telnet",["$rootScope","$timeout","promptParser",function(a,b,c){var d=a.$new();d.outputBuffer="",d.bConnected=!1,d.maxScrollback=2e4,d.server="",d.port="",d.telnetEvents={parsePrompt:"TELNET_PARSE_PROMPT",parseTextPrompt:"TELNET_PARSE_INVALID_PROMPT",parseBlock:"TELNET_PARSE_BLOCK",parseLine:"TELNET_PARSE_LINE",connect:"TELNET_CONNECT",disconnect:"TELNET_DISCONNECT",bufferUpdated:"TELNET_OUTPUT_BUFFER_UPDATE"};var e={};e.ECHO=1,e.LF=10,e.CR=13,e.ESC=27,e.WILL=251,e.WONT=252,e.DO=253,e.DONT=254,e.IAC=255;var f=new Websock,g=0,h="",i="",j="",k=1,l=0,m=!1,n=!1,o=function(a){n&&window.console&&console.log(a)},p=function(){for(var a="";l>0;)a+="</span>",l--;return a},q=function(a,b){return parseInt(a,10)-parseInt(b,10)},r=function(a){if(m?(d.outputBuffer+=a,m=!1):d.outputBuffer+="<br />"+a,d.outputBuffer.length>d.maxScrollback){var c=d.outputBuffer.indexOf("<block_marker />",d.outputBuffer.length-d.maxScrollback+Math.ceil(.2*d.maxScrollback));c>0&&(d.outputBuffer=d.outputBuffer.substr(c+16))}n&&o("telnet: "+a),b(function(){d.$apply("outputBuffer"),d.$broadcast(d.telnetEvents.bufferUpdated)},0,!1)},s=function(a){for(var b="",n=0;n<a.length;n++){var s=a[n];switch(g){case 0:s===e.IAC?g=1:s===e.ECHO?k=0===k?1:0:s===e.ESC?g=3:s===e.LF?(r(j),i.length>0&&(h+=i+"\n"),i="",j=""):s!==e.CR&&(i+=String.fromCharCode(s),j+=60===s?"&lt;":62===s?"&gt;":String.fromCharCode(s));break;case 1:g=s===e.DO?2:0;break;case 2:f.send([e.IAC,e.WONT,s]),g=0;break;case 3:if("["===String.fromCharCode(s)){b="",g=4;continue}"c"===String.fromCharCode(s)?(p(),d.outputBuffer="",d.$broadcast(d.telnetEvents.bufferUpdated)):"M"===String.fromCharCode(s)?o("[Scroll Up]"):"D"===String.fromCharCode(s)?o("[Scroll Down]"):"H"===String.fromCharCode(s)?o("[Set Tab]"):"8"===String.fromCharCode(s)?o("[Restore Cursor & Attrs]"):"7"===String.fromCharCode(s)?o("[Save Cursor & Attrs]"):")"===String.fromCharCode(s)?o("[Font Set G0]"):"("===String.fromCharCode(s)?o("[Font Set G1]"):o("[unknown escape code : "+s+"]"),g=0;break;case 4:if(s>=48&&57>=s||59===s)b+=String.fromCharCode(s);else if("m"===String.fromCharCode(s)){var t=0,u="",v=b.split(";");v.sort(q);for(var w=0;w<v.length;w++){var x=parseInt(v[w],10);0===x&&l>0&&(j+=p()),1===x&&(t=8),(2===x||22===x)&&(t=0),3===x&&(u+="italic "),4===x&&(u+="uline "),(5===x||6===x)&&(u+="blink "),7===x&&(u="fg8 bg1"),9===x&&(u+="strikethrough "),37>=x&&x>=30&&(u+="fg"+(x-29+t)),47>=x&&x>=40&&(u+="bg"+(x-39+t))}u.length>0&&(j+='<span class="'+u+'">',l++),g=0}else o("[ansi:"+b+String.fromCharCode(s)+"]"),g=0}}if(h.length>0){for(var y=h.split("\n"),z=0;z<y.length;z++){var A=y[z];""!==$.trim(A)&&d.$broadcast(d.telnetEvents.parseLine,A)}""!==$.trim(h)&&d.$broadcast(d.telnetEvents.parseBlock,h),h=""}if(""!==j){r(j),j="";var B=c.parse(i);null!==B?(m=!1,d.$broadcast(d.telnetEvents.parsePrompt,B)):(m=!0,""!==$.trim(i)&&d.$broadcast(d.telnetEvents.parseTextPrompt,i))}m||(i="",l&&(m=!0,r(p())),d.outputBuffer+="<block_marker />")};f.on("message",function(){s(f.rQshiftBytes(f.rQlen()))}),f.on("open",function(){d.bConnected=!0,m=!1,r('<span class="cmd">Connected to '+d.server+":"+d.port+"</span>"),d.$broadcast(d.telnetEvents.connect)}),f.on("close",function(){d.bConnected=!1,m=!1,r('<span class="cmd">Disconnected...</span>'),d.$broadcast(d.telnetEvents.disconnect)}),f.on("error",function(){m=!1,r('<span class="cmd">Connection error occured...</span>')});var t={send:function(a){var b=m,c="";m=!0,k&&""!==a&&(c+='<span class="cmd">'+a+"</span> "),b&&(c+=p()+"<block_marker />",i=""),f.send_string(a+"\n"),n&&o("send (appending prompt:"+b+"): "+a),r(c)},silentSend:function(a){var b=k;k=!1,t.send(a),k=b,n&&o("telnet echo mode disabled for previous send")},connect:function(a,b){"string"!=typeof a?(a=d.server,b=d.port):(d.server=a,d.port=b),b=b||d.port,f.open("ws://"+a+":"+b,["binary","base64"])},disconnect:function(){f.close()},setConsoleOutput:function(a){n=a===!0},onNextPrompt:function(a,b){var c=d.$on(d.telnetEvents.parsePrompt,function(){c(),void 0!==b&&b(),""!==a&&t.send(a)})},$scope:d};return t}]),angular.module("clientApp").directive("scanDirection",["autoscan","buttons",function(a,b){var c=function(a){switch(a){case"north":return"arrow-up";case"up":return"caret-up";case"east":return"arrow-right";case"south":return"arrow-down";case"down":return"caret-down";case"west":return"arrow-left";case"here":return"bolt";case"refresh":return"refresh"}};return{restrict:"A",replace:!1,scope:!1,link:function(d,e,f){if(e.addClass("icon-"+c(f.scanDirection)),e.addClass("btn btn-block"),"refresh"!==f.scanDirection){var g=a.$scope.$watch("adjacentRooms."+f.scanDirection,function(a){void 0!==a?(e.removeClass("disabled muted btn-danger btn-info"),"mobs"===a.type?e.addClass("btn-danger"):("locked"===a.type||"dark"===a.type)&&e.addClass("btn-info")):(e.removeClass("btn-danger btn-info"),e.addClass("disabled muted"))},!0),h=b.$scope.$watch("buttonSet",function(a){a===f.scanDirection?e.addClass("selected"):e.removeClass("selected")});d.$on("$destroy",function(){g(),h()})}e.bind("click",function(){d.directionClick(f.scanDirection)})}}}]),angular.module("clientApp").directive("telnetSend",["telnet",function(a){return function(b,c,d){c.bind("click",function(){a.send(d.telnetSend)})}}]),angular.module("clientApp").directive("telnetStatus",["telnet",function(a){return{restrict:"A",replace:!1,link:function(b,c){var d=a.$scope.$watch("bConnected",function(b){b?c.removeClass("disconnected").addClass("connected").off("click",a.connect).on("click",a.disconnect):c.removeClass("connected").addClass("disconnected").off("click",a.disconnect).on("click",a.connect)});b.$on("$destroy",function(){d()})}}}]),angular.module("clientApp").directive("autoscroll",["$window","$timeout",function(a,b){return{restrict:"E",scope:{content:"="},link:function(c,d){var e=!0,f=d.parent();f.bind("pause",function(){e=!e});var g=function(){return Math.max(f[0].scrollHeight,f[0].clientHeight)-f[0].clientHeight},h=c.$watch("content",function(a){f.html(a),e&&(f[0].scrollTop=g())}),i=function(){e=!0,f[0].scrollTop=g()},j=function(a){e===!1&&(13===a.which?i():32===a.which&&(a.preventDefault(),i()))};angular.element(a).bind("resize",i),angular.element(a).bind("keydown",j),c.$on("$destroy",function(){h(),angular.element(a).unbind("resize",i),angular.element(a).unbind("keydown",j),f.unbind("pause")}),f.on("scroll",function(){g()===f[0].scrollTop&&(e=!0)}),b(function(){i()},0)}}}]),angular.module("clientApp").controller("CommandBarCtrl",["$scope","telnet","$timeout","keypress","playerStatus",function(a,b,c,d,e){e.$scope.enableButtonRedirects=e.$scope.enableButtonRedirects||!1,a.command="",a.aCommands=[],a.commandPos=0,a.commandMaxLength=50,a.pauseTelnetScrollback=function(){$("#telnetOutput").trigger("pause")},a.enterCommand=function(){(0===a.commandPos||a.aCommands[a.aCommands.length-a.commandPos]!==a.command)&&a.aCommands.push(a.command),a.commandPos=0,a.aCommands.length>a.commandMaxLength&&(a.aCommands=a.aCommands.slice(1)),b.send(a.command),a.command="",c(function(){a.$apply("command")},0,!1)};var f=function(b){a.historyChange(39-b.which)};a.historyChange=function(b){a.commandPos=Math.max(0,a.commandPos+b)%(a.aCommands.length+1),a.command=a.commandPos?a.aCommands[a.aCommands.length-a.commandPos]:"",c(function(){a.$apply("command")},0,!1)},a.keyDown=function(b){var c=b.keyCode?b.keyCode:b.which;switch(c){case 13:b.preventDefault(),a.enterCommand();break;case 27:case 33:case 34:d.keyDown(b);break;case 38:case 40:b.shiftKey?(b.preventDefault(),f(b)):(b.preventDefault(),d.keyDown(b));break;case 9:b.preventDefault(),d.keyDown(b);break;default:e.$scope.enableButtonRedirects&&""===a.command&&(c>=48&&57>=c||-1!==$.inArray(c,[192,37,39,187,189]))&&(b.preventDefault(),d.keyDown(b))}}}]),angular.module("clientApp").directive("commandBar",function(){return{templateUrl:"templates/commandBar.tpl.html",restrict:"E",replace:!0,scope:!1,link:function(a,b){var c=function(a){e||-1!==$.inArray(a.which,[0,16,17,18,91,93])||a.ctrlKey||a.metaKey||-1!==$.inArray(document.activeElement.tagName.toLowerCase(),["input","textarea"])||(d.focus(),b.trigger(a))};b.on("keydown",function(b){a.keyDown(b)});var d=b.find("input").eq(0).focus(),e=!0;d.bind("blur",function(){e=!1}),d.bind("focus",function(){e=!0}),$(window).on("keydown",c),a.$on("$destroy",function(){$(window).off("keydown",c)})}}}),angular.module("clientApp").controller("CommandButtonsCtrl",["$scope","buttons","telnet","keypress","playerStatus",function(a,b,c,d,e){a.buttons=b;var f=e.$scope.$watch("playerState",function(a){b.setProfileButtons(a)}),g=d.$scope.$on(d.events.keydown,function(b,c){var e=d.getEventKey(c),f=-1;switch(e){case"minus":f=10;break;case"equal":f=11;break;case 0:f=9;break;default:"number"==typeof e&&(f=e-1)}-1!==f&&a.clickButton(f)});a.$on("$destroy",function(){g(),f()}),a.clickButton=function(a){if(b.$scope.aActiveButtons.length>a&&b.$scope.aActiveButtons[a].command.length){for(var d=b.$scope.aActiveButtons[a].command.split(" & "),f=0;f<d.length;f++)c.send(d[f]);"mobs"===b.$scope.buttonType&&e.changeState("combat")}b.resetButtons()}}]),angular.module("clientApp").factory("autoscan",["$rootScope","telnet","$timeout","playerStatus",function(a,b,c,d){var e=a.$new();e.adjacentRooms={};var f=/^(\[Exits:|You see nothing in the vicinity\.)/,g=/,\s+(?=a|an|the|two|three|four|five|six|seven|eight|nine|ten|[A-Z]\S+)/,h=/^\s+(?=a|an|the|two|three|four|five|six|seven|eight|nine|ten|[A-Z]\S+)/,i={n:"north",e:"east",s:"south",w:"west",u:"up",d:"down"},j=!1,k=!1,l={},m="";b.$scope.$on(b.$scope.telnetEvents.parseLine,function(a,b){b.match(f)&&(j=!0,l={});var c=b.match(/^\s*\[?(Here|east|west|north|south|up|down)]?\s*:\s*(.*)$/);c?(j=!0,k=!0,m=c[1].toLowerCase(),l[m]=c[2]):k&&b.match(h)?l[m]+=b:k=!1}),b.$scope.$on(b.$scope.telnetEvents.parsePrompt,function(a,b){if(j){for(var f in l)if("darkness"===l[f])l[f]={type:"dark",buttons:[{label:"refresh light",command:"refreshLight"}]};else{l[f]=l[f].replace(/^\s*/,"").split(g);for(var h=l[f].length-1;h>=0;h--){var m={label:l[f][h].toLowerCase()},o=m.label.replace(/^\s*([^A-Z]\S*)?\s+/,"").replace(/(ves|ies|es|s)\b/g,"").replace(/\s+(the|\w|\w\w)(?=\s+)/g,"").replace(/[^a-zA-Z- ]+/g,"").split(" ").join(".");"here"===f?d.$scope.party.hasOwnProperty(l[f][h])?m=null:m.command="kill "+o:m.command=f+" & "+"kill "+o,null!==m?l[f][h]=m:l[f].splice(h,1)}l[f]=l[f].length?{type:"mobs",buttons:l[f]}:{type:"empty",buttons:[]}}if("none"!==b.exits&&"??"!==b.exits)for(var p in b.exits){var q=b.exits[p].toLowerCase(),r=i[q];l.hasOwnProperty(i[q])||(l[i[q]]=q!==b.exits[p]?{type:"empty",buttons:[]}:{type:"locked",buttons:[{label:"open "+r,command:"open "+r+" & scan"},{label:"unlock "+r,command:"unlock "+r+" & scan"},{label:"knock "+r,command:"knock "+r+" & scan"},{label:"pull lever",command:"pull lever & scan"},{label:"pound gate",command:"pound gate & scan"},{label:"move rubble",command:"move rubble & scan"},{label:"open door",command:"open door & scan"},{label:"unlock door",command:"unlock door & scan"},{label:"knock door",command:"knock door & scan"}]})}e.adjacentRooms=l,l={},k=!1,j=!1,c(function(){e.$broadcast(n.events.room_changed)},0,!0)}});var n={events:{room_changed:"AUTOSCAN_ROOM_CHANGE_DETECTED"},directionExists:function(a){return e.adjacentRooms.hasOwnProperty(a)},hasButtons:function(a){return n.directionExists(a)&&e.adjacentRooms[a].buttons.length>0},getButtons:function(a){return n.directionExists(a)?e.adjacentRooms[a].buttons:[]},getButtonType:function(a){return n.directionExists(a)?e.adjacentRooms[a].type:"empty"},$scope:e};return n}]),angular.module("clientApp").factory("keypress",["$rootScope",function(a){var b=a.$new(),c={keydown:"UNHANDLED_KEY_DOWN"};return{keyDown:function(a){b.$broadcast(c.keydown,a)},getEventKey:function(a){var b=a.which;switch(b){case 9:return"tab";case 13:return"enter";case 27:return"esc";case 32:return"space";case 33:return"pageup";case 34:return"pagedown";case 37:return"left";case 38:return"up";case 39:return"right";case 40:return"down";case 192:return"tilde";case 187:return"equal";case 189:return"minus"}return b>=48&&57>=b?b-48:"unknown"},$scope:b,events:c}}]),angular.module("clientApp").factory("buttons",["$rootScope","autoscan","profile","$timeout",function(a,b,c,d){var e=a.$new();e.buttonMode="profile",e.profileSet="",e.buttonType="",e.buttonSet="",e.aActiveButtons=[];var f=function(){d(function(){e.$apply("aActiveButtons")},0,!1)},g={$scope:e,setDirectionButtons:function(a){var c=b.getButtons(a);c.length&&(e.buttonMode="direction",e.buttonType=b.getButtonType(a),e.buttonSet=a,e.aActiveButtons=g.padButtons(c),f())},resetButtons:function(){g.setProfileButtons(e.profileSet)},setProfileButtons:function(a){(e.buttonSet!==a||"profile"!==e.buttonMode)&&(e.buttonMode="profile",e.buttonType="user",e.buttonSet=a,e.aActiveButtons=g.padButtons(c.getButtons(a)),e.profileSet=a,f())},indexToKey:function(a){switch(a){case 9:return 0;case 10:return"-";case 11:return"=";default:return a+1}},padButtons:function(a){if(a.length<12)for(var b=a.length;12>b;b++)a.push({command:"",label:""});return a}};return g.setProfileButtons("standing"),g}]),angular.module("clientApp").controller("EditButtonsCtrl",["$scope","profile","$location","buttons",function(a,b,c,d){a.buttons=d,a.aButtonSets=b.getButtonSets();var e=[],f=function(c){a.activeButtons=d.padButtons(b.getButtons(c)),e=angular.copy(a.activeButtons)};a.buttonSet="standing",f(a.buttonSet),a.done=function(){c.path("/")},a.undo=function(){a.activeButtons=angular.copy(e)},a.reset=function(){confirm("Are you sure you want to reset ALL your button sets?")&&(a.buttonSet="combat",b.resetButtonsToDefault(),a.buttonSet="standing")},a.$watch("buttonSet",function(a){f(a)})}]),angular.module("clientApp").factory("profile",[function(){var a,b={buttons:{standing:[{label:"look",command:"look & scan"},{label:"skin corpse",command:"skin corpse"},{label:"score",command:"score"},{label:"inventory",command:"inventory"},{label:"drink water",command:"drink water"},{label:"eat food",command:"eat food"}],combat:[{label:"kick",command:"kick"},{label:"punch",command:"punch"}],sleeping:[{label:"stand",command:"stand"},{label:"score",command:"score"},{label:"notes",command:"note summary"}]}},c={get:function(a){var c=$.jStorage.get(a);return c?JSON.parse(c):b[a]}},d={getButtonSets:function(){var b=[];for(var c in a)a.hasOwnProperty(c)&&b.push(c);return b},getButtons:function(b){return a.hasOwnProperty(b)||(a[b]=[]),a[b]},resetButtonsToDefault:function(){a=angular.extend({},b.buttons)},save:function(){$.jStorage.set("buttons",JSON.stringify(a))},load:function(){a=c.get("buttons")}};return d.load(),d}]),angular.module("clientApp").factory("playerStatus",["$rootScope","telnet","$q",function(a,b,c){var d=a.$new();d.events={fullPartyUpdate:"ALL_PARTY_INFO_UPDATED",playerOnline:"PLAYER_INFO_PARSED_PLAYER_ONLINE"},d.online=!1,d.scrollingPaused=!1,d.enableButtonRedirects=!1,d.name="TFE",d.leader="",d.party={},d.playerState="standing",d.self={hp:1,hpMax:1,e:1,eMax:1,mv:1,mvMax:1},b.$scope.$on(b.$scope.telnetEvents.parsePrompt,function(a,b){d.$apply(function(){d.self.hp=b.hp,d.self.e=b.e,d.self.mv=b.mv,d.self.xp=b.xp}),e.changeState(b.playerState)}),b.$scope.$on(b.$scope.telnetEvents.parseLine,function(a,c){var e=c.match(/^Leader:\s*(.*)\s*$/);if(e){d.leader=e[1];var f={},g=b.$scope.$on(b.$scope.telnetEvents.parseLine,function(a,b){var c=b.match(/^\[\s+(\d+)\s+(\w+)\s+\S+\s+\]\s+(\S+)\s*(\d+)\/(\d+)\s+(\d+)\/(\d+)\s+(\d+)\/(\d+)\s+(\d+)\s*$/);if(c)f[c[3]]={incog:!1,level:parseInt(c[1],10),"class":c[2],hp:parseInt(c[4],10),hpMax:parseInt(c[5],10),e:parseInt(c[6],10),eMax:parseInt(c[7],10),mv:parseInt(c[8],10),mvMax:parseInt(c[9],10),xp:parseInt(c[10],10)};else{var d=b.match(/^\[\s*Incognito\s*\]\s+(\S+)\s+(.*)\s*$/);d&&(f[d[1]]={incog:!0,status:d[2]})}});b.onNextPrompt("",function(){g(),d.$apply(function(){d.party=f,f.hasOwnProperty(d.name)&&(d.self=f[d.name])}),d.$broadcast(d.events.fullPartyUpdate)})}});var e={$scope:d,findName:function(){var a=c.defer();return b.onNextPrompt("score",function(){var c="",e=b.$scope.$on(b.$scope.telnetEvents.parseLine,function(b,f){f.match(/^\s*-+\s*$/)&&(e(),d.$apply(function(){d.name=$.trim(c),d.online||(d.online=!0,d.$broadcast(d.events.playerOnline),d.enableButtonRedirects=!0),a.resolve(d.name)})),c=f})}),a.promise},updateGroup:function(){var a=c.defer();return b.onNextPrompt("group",function(){var b=d.$on(d.events.fullPartyUpdate,function(){b(),a.resolve(d.party)})}),a.promise},changeState:_.debounce(function(a){d.$apply(function(){d.playerState=a})},1e3,!0)};return e}]),angular.module("clientApp").factory("promptParser",function(){var a=/^(?: -- MORE -- )?<([^|]*\|)?(\d+)hp (\d+)e \[?(\d+)mv\]? (\d+)wm (\d+)xp (perfect|scratched|bruised|cut|wounded|badly wounded|nastily wounded|bleeding freely|covered in blood|leaking guts|mostly dead|\?\?)?\s?([NESWUDneswud]+|none|\?\?)\s?(perfect|scratched|bruised|cut|wounded|badly wounded|nastily wounded|bleeding freely|covered in blood|leaking guts|mostly dead)?>\s*$/,b="",c=null,d={parse:function(d){if(d===b)return c;var e=null,f=d.match(a);return null!==f&&(e={flags:f[1],hp:parseInt(f[2],10),e:parseInt(f[3],10),mv:parseInt(f[4],10),wm:parseInt(f[5],10),xp:parseInt(f[6],10),leaderState:f[7],exits:f[8],targetState:f[9],playerState:""},e.playerState=void 0!==e.targetState?"combat":"??"===e.exits?"sleeping":"standing",b=d,c=e),e}};return d}),angular.module("clientApp").factory("map",["$rootScope","telnet","$location",function(a,b,c){var d=a.$new();d.aMap=["              *              ","                             ","                             ","                             ","                             ","                             ","                             ","                             ","                             ","                             ","                             ","                             ","                             "],d.posX=14,d.posY=0,d.aMove=[],d.oCurrentMove={direction:"",type:"exit"},b.$scope.$on(b.$scope.telnetEvents.parseLine,function(a,e){if("You survey the area, then consult your atlas:"===e){var f=[],h=b.$scope.$on(b.$scope.telnetEvents.parseLine,function(a,b){f.push(b)});b.onNextPrompt("",function(){for(h();""===$.trim(f[0]);)f.splice(0,1);for(var a=0;a<f.length;a+=2)if(f[a]=f[a].substring(0,29),f[a].match(/\|/)){console.log("padding map due to line "+a+" : "+f[a]),f.unshift("                                  ");break}for(;f.length<14;)f.push("                                  ");f=f.splice(0,13);for(var b=0;b<f.length;b++){f[b].length<29&&(f[b]=f[b]+"                                  "),f[b]=f[b].substring(0,29);var e=f[b].indexOf("*");-1!==e&&(d.posX=e,d.posY=b)}d.aMap=f,c.path("/map")})}else{var i=e.match(/(?:You|You follow)\s(\S+\s?\S*)\s(north|east|south|west|up|down)\.$/);i&&i[2]===d.oCurrentMove.direction&&g.moveStep()}});var e=function(a,b){return b>=0&&b<d.aMap.length&&a>=0&&a<d.aMap[b].length&&" "!==d.aMap[b][a]?d.aMap[b][a]:""},f=function(a,b){return a.toString()+","+b.toString()},g={getShortestPath:function(a,b){var c={},g=[],h=function(a,b,c,d){return{x:a,y:b,id:f(a,b),path:c,cost:d}},i=f(a,b),j=function(a,b){var c=a.slice(0);return c.push(b),c},k=function(a,b){return a.cost-b.cost},l=function(a,b,d){var g,i;switch(d){case"north":g=0,i=-1;break;case"south":g=0,i=1;break;case"east":g=1,i=0;break;case"west":g=-1,i=0}var k=b.x+g+g,l=b.y+i+i;if(!c.hasOwnProperty(f(k,l))){var m=e(k,l);if(""!==m){var n=e(b.x+g,b.y+i);switch(n){case"+":return a.push(h(k,l,j(b.path,{direction:d,type:"door"}),b.cost+11)),void 0;case"|":case"-":return a.push(h(k,l,j(b.path,{direction:d,type:"exit"}),b.cost+10)),void 0;case"":case" ":return;default:return a.push(h(k,l,j(b.path,{direction:d,type:"unknown"}),b.cost+13)),void 0}}}},m=function(a){var b=[];return l(b,a,"north"),l(b,a,"east"),l(b,a,"south"),l(b,a,"west"),b},n=function(a){for(var b=m(a),d={},e=0;e<b.length;e++)d[b[e].id]=!0;if(b.length){for(var f=0;f<g.length;f++)if(d.hasOwnProperty(g[f].id))for(var h=b.length-1;h>=0;h--)g[f].id===b[h].id&&(g[f].cost<b[h].cost&&(g[f]=b[h]),b.splice(h,1));for(var j=0;j<b.length;j++)g.push(b[j])}if(g.length){g.sort(k);var l=g.splice(0,1)[0];if(c[l.id]=l,l.id===i)return;n(l)}},o=h(d.posX,d.posY,[],0);return c[o.id]=o,n(o),c.hasOwnProperty(i)?c[i].path:[]},moveStep:function(){d.aMove.length?(d.oCurrentMove=d.aMove.splice(0,1)[0],g.move()):d.oCurrentMove.direction=""},move:function(){b.send(d.oCurrentMove.direction),c.path("/")}},h={$scope:d,reverseDirection:function(a){switch(a){case"north":return"south";case"east":return"west";case"south":return"north";case"west":return"east";case"up":return"down";case"down":return"up"}},moveTo:function(a,b){d.aMove=g.getShortestPath(a,b),d.aMove.length&&g.moveStep()}};return h}]),angular.module("clientApp").controller("MapViewCtrl",["$scope","map",function(a,b){a.map=b}]),angular.module("clientApp").directive("mapView",function(){var a=function(a){switch(a){case"O":case">":case"<":case"X":case"?":return"room";case"*":return"here"}},b=function(a){switch(a){case"-":return'<i class="icon-resize-horizontal"></i>';case"|":return'<i class="icon-resize-vertical"></i>';case"+":return"+";case"?":return"?";case">":return'<i class="icon-sort-up"></i>';case"<":return'<i class="icon-sort-down"></i>';case"X":return'<i class="icon-sort"></i>'}},c=function(c){for(var d=c.$scope.aMap,e=[],f=function(){var a=$(this).data();c.moveTo(parseInt(a.x,10),parseInt(a.y,10))},g=0;13>g;g++){var h=angular.element("<div>");h.addClass(g%2?"mapSpaceRow":"mapRoomRow");for(var i=0;29>i;i++){var j=a(d[g][i]),k=angular.element("<div>").append(b(d[g][i])).addClass(j).data("x",i).data("y",g).appendTo(h);"room"===j&&k.bind("click",f)}e.push(h)}return e};return{restrict:"A",replace:!1,controller:"MapViewCtrl",link:function(a,b){b.addClass("map"),b.append(c(a.map))}}});