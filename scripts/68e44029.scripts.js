"use strict";angular.module("clientApp",["templates-main","$strap.directives","ui.bootstrap.modal","ui.bootstrap.dropdownToggle"]).config(["$routeProvider","$locationProvider",function(e,t){t.html5Mode(!1),e.when("/",{templateUrl:"views/main.html"}).when("/about",{templateUrl:"views/about.html"}).when("/map",{templateUrl:"views/map.html"}).when("/contact",{templateUrl:"views/contact.html"}).when("/config/buttons",{templateUrl:"views/editButtons.html"}).otherwise({redirectTo:"/"})}]),angular.module("clientApp").controller("MainCtrl",["$scope","$rootScope","$window","telnet","$timeout","profile","playerStatus","$http","map",function(e,t,n,r,o,i,a,s,u){e.bIsDev="localhost"===$(location).attr("hostname"),t.telnet=r,t.map=u,t.playerStatus=a,s.get("version.json").success(function(e){var n=e.version.split(".");t.version={major:parseInt(n[0],10),minor:parseInt(n[1],10),hash:n[2]}});var c=function(){var e=!1,r=t.windowOrientation;t.windowHeight!==n.innerHeight&&(t.windowHeight=n.innerHeight,e=!0),t.windowWidth!==n.innerWidth&&(t.windowWidth=n.innerWidth,e=!0),t.windowOrientation=t.windowHeight>t.windowWidth||940>t.windowWidth?"portrait":"landscape",r!==t.windowOrientation&&(e=!0),e&&o(function(){t.$digest()},0,!1)};angular.element(n).bind("resize",function(){c()}),c(),a.findName().then(function(){a.updateGroup()}),n.onbeforeunload=function(){return i.save(),!e.bIsDev&&r.$scope.bConnected?"You are currently connected to "+r.$scope.server:void 0};var l=8e3,f="theforestsedge.com";e.bIsDev&&(l=7e3,f="vault-thirteen.net",r.$scope.$on(r.$scope.telnetEvents.parseTextPrompt,function(e,t){t.match(/Choice:/)?r.send("Tester"):t.match(/Password:/)?r.silentSend("TesterPassword"):t.match(/Press <return> to continue./)?r.send(""):t.match(/Disconnect previous link?/)&&r.send("y")})),r.connect(f,l)}]),angular.module("clientApp").controller("ScanCtrl",["$scope","autoscan","buttons","keypress","telnet",function(e,t,n,r,o){var i=function(e){switch(e){case"up":return"north";case"tilde":return"here";case"down":return"south";case"left":return"west";case"right":return"east";case"pageup":return"up";case"pagedown":return"down";case"tab":return"refresh";case"esc":return"reset"}return""},a=r.$scope.$on(r.events.keydown,function(t,n){var o=r.getEventKey(n),a=i(o);""!==a&&e.directionClick(a)}),s=t.$scope.$on(t.events.room_changed,function(){n.resetButtons()});e.$on("$destroy",function(){a(),s()}),e.directionClick=function(e){"reset"===e?n.resetButtons():"refresh"===e?(n.resetButtons(),o.send("scan")):n.$scope.buttonSet!==e&&t.hasButtons(e)?n.$scope.buttonSet!==e&&n.setDirectionButtons(e):"here"!==e&&o.send(e)}}]),angular.module("clientApp").factory("telnet",["$rootScope","$timeout","promptParser",function(e,t,n){var r=e.$new();r.outputBuffer="",r.bConnected=!1,r.maxScrollback=2e4,r.server="",r.port="",r.telnetEvents={parsePrompt:"TELNET_PARSE_PROMPT",parseTextPrompt:"TELNET_PARSE_INVALID_PROMPT",parseBlock:"TELNET_PARSE_BLOCK",parseLine:"TELNET_PARSE_LINE",connect:"TELNET_CONNECT",disconnect:"TELNET_DISCONNECT",bufferUpdated:"TELNET_OUTPUT_BUFFER_UPDATE"};var o={};o.ECHO=1,o.LF=10,o.CR=13,o.ESC=27,o.WILL=251,o.WONT=252,o.DO=253,o.DONT=254,o.IAC=255;var i=new Websock,a=0,s="",u="",c="",l=1,f=0,p=!1,d=!1,h=function(e){d&&window.console&&console.log(e)},m=function(){for(var e="";f>0;)e+="</span>",f--;return e},g=function(e,t){return parseInt(e,10)-parseInt(t,10)},v=function(e){if(p?(r.outputBuffer+=e,p=!1):r.outputBuffer+="<br />"+e,r.outputBuffer.length>r.maxScrollback){var n=r.outputBuffer.indexOf("<block_marker />",r.outputBuffer.length-r.maxScrollback+Math.ceil(.2*r.maxScrollback));n>0&&(r.outputBuffer=r.outputBuffer.substr(n+16))}d&&h("telnet: "+e),t(function(){r.$apply("outputBuffer"),r.$broadcast(r.telnetEvents.bufferUpdated)},0,!1)},y=function(e){for(var t="",d=0;e.length>d;d++){var y=e[d];switch(a){case 0:y===o.IAC?a=1:y===o.ECHO?l=0===l?1:0:y===o.ESC?a=3:y===o.LF?(v(c),u.length>0&&(s+=u+"\n"),u="",c=""):y!==o.CR&&(u+=String.fromCharCode(y),c+=60===y?"&lt;":62===y?"&gt;":String.fromCharCode(y));break;case 1:a=y===o.DO?2:0;break;case 2:i.send([o.IAC,o.WONT,y]),a=0;break;case 3:if("["===String.fromCharCode(y)){t="",a=4;continue}"c"===String.fromCharCode(y)?(m(),r.outputBuffer="",r.$broadcast(r.telnetEvents.bufferUpdated)):"M"===String.fromCharCode(y)?h("[Scroll Up]"):"D"===String.fromCharCode(y)?h("[Scroll Down]"):"H"===String.fromCharCode(y)?h("[Set Tab]"):"8"===String.fromCharCode(y)?h("[Restore Cursor & Attrs]"):"7"===String.fromCharCode(y)?h("[Save Cursor & Attrs]"):")"===String.fromCharCode(y)?h("[Font Set G0]"):"("===String.fromCharCode(y)?h("[Font Set G1]"):h("[unknown escape code : "+y+"]"),a=0;break;case 4:if(y>=48&&57>=y||59===y)t+=String.fromCharCode(y);else if("m"===String.fromCharCode(y)){var b=0,w="",x=t.split(";");x.sort(g);for(var C=0;x.length>C;C++){var S=parseInt(x[C],10);0===S&&f>0&&(c+=m()),1===S&&(b=8),(2===S||22===S)&&(b=0),3===S&&(w+="italic "),4===S&&(w+="uline "),(5===S||6===S)&&(w+="blink "),7===S&&(w="fg8 bg1"),9===S&&(w+="strikethrough "),37>=S&&S>=30&&(w+="fg"+(S-29+b)),47>=S&&S>=40&&(w+="bg"+(S-39+b))}w.length>0&&(c+='<span class="'+w+'">',f++),a=0}else h("[ansi:"+t+String.fromCharCode(y)+"]"),a=0}}if(s.length>0){for(var k=s.split("\n"),T=0;k.length>T;T++){var E=k[T];""!==$.trim(E)&&r.$broadcast(r.telnetEvents.parseLine,E)}""!==$.trim(s)&&r.$broadcast(r.telnetEvents.parseBlock,s),s=""}if(""!==c){v(c),c="";var N=n.parse(u);null!==N?(p=!1,r.$broadcast(r.telnetEvents.parsePrompt,N)):(p=!0,""!==$.trim(u)&&r.$broadcast(r.telnetEvents.parseTextPrompt,u))}p||(u="",f&&(p=!0,v(m())),r.outputBuffer+="<block_marker />")};i.on("message",function(){y(i.rQshiftBytes(i.rQlen()))}),i.on("open",function(){r.bConnected=!0,p=!1,v('<span class="cmd">Connected to '+r.server+":"+r.port+"</span>"),r.$broadcast(r.telnetEvents.connect)}),i.on("close",function(){r.bConnected=!1,p=!1,v('<span class="cmd">Disconnected...</span>'),r.$broadcast(r.telnetEvents.disconnect)}),i.on("error",function(){p=!1,v('<span class="cmd">Connection error occured...</span>')});var b={send:function(e){var t=p,n="";p=!0,l&&""!==e&&(n+='<span class="cmd">'+e+"</span>"),t&&(n+=m()+"<block_marker />",u=""),i.send_string(e+"\n"),d&&h("send (appending prompt:"+t+"): "+e),v(n)},silentSend:function(e){var t=l;l=!1,b.send(e),l=t,d&&h("telnet echo mode disabled for previous send")},connect:function(e,t){"string"!=typeof e?(e=r.server,t=r.port):(r.server=e,r.port=t),t=t||r.port,i.open("ws://"+e+":"+t,["binary","base64"])},disconnect:function(){i.close()},setConsoleOutput:function(e){d=e===!0},onNextPrompt:function(e,t){var n=r.$on(r.telnetEvents.parsePrompt,function(){n(),void 0!==t&&t(),""!==e&&b.send(e)})},$scope:r};return b}]),angular.module("clientApp").directive("scanDirection",["autoscan","buttons",function(e,t){var n=function(e){switch(e){case"north":return"arrow-up";case"up":return"caret-up";case"east":return"arrow-right";case"south":return"arrow-down";case"down":return"caret-down";case"west":return"arrow-left";case"here":return"bolt";case"refresh":return"refresh"}};return{restrict:"A",replace:!1,scope:!1,link:function(r,o,i){if(o.addClass("icon-"+n(i.scanDirection)),o.addClass("btn btn-block"),"refresh"!==i.scanDirection){var a=e.$scope.$watch("adjacentRooms."+i.scanDirection,function(e){void 0!==e?(o.removeClass("disabled muted btn-danger btn-info"),"mobs"===e.type?o.addClass("btn-danger"):("locked"===e.type||"dark"===e.type)&&o.addClass("btn-info")):(o.removeClass("btn-danger btn-info"),o.addClass("disabled muted"))},!0),s=t.$scope.$watch("buttonSet",function(e){e===i.scanDirection?o.addClass("selected"):o.removeClass("selected")});r.$on("$destroy",function(){a(),s()})}o.bind("click",function(){r.directionClick(i.scanDirection)})}}}]),angular.module("clientApp").directive("telnetSend",["telnet",function(e){return function(t,n,r){n.bind("click",function(){e.send(r.telnetSend)})}}]),angular.module("clientApp").directive("telnetStatus",["telnet",function(e){return{restrict:"A",replace:!1,link:function(t,n){var r=e.$scope.$watch("bConnected",function(t){t?n.removeClass("disconnected").addClass("connected").off("click",e.connect).on("click",e.disconnect):n.removeClass("connected").addClass("disconnected").off("click",e.disconnect).on("click",e.connect)});t.$on("$destroy",function(){r()})}}}]),angular.module("clientApp").directive("autoscroll",["telnet","$window","$timeout",function(e,t,n){return{restrict:"A",scope:!1,link:function(r,o){var i=!0,a=function(){return Math.max(o[0].scrollHeight,o[0].clientHeight)-o[0].clientHeight},s=e.$scope.$on(e.$scope.telnetEvents.bufferUpdated,function(){i&&(o[0].scrollTop=a())}),u=function(){i=!0,o[0].scrollTop=a()},c=function(e){i===!1&&(13===e.which?u():32===e.which&&(e.preventDefault(),u()))};angular.element(t).bind("resize",u),angular.element(t).bind("keydown",c),r.$on("$destroy",function(){s(),angular.element(t).unbind("resize",u),angular.element(t).unbind("keydown",c)}),o.on("scroll",function(){i=a()!==o[0].scrollTop?!1:!0}),n(function(){u()},0)}}}]),angular.module("clientApp").controller("CommandBarCtrl",["$scope","telnet","$timeout","keypress",function(e,t,n,r){e.command="",e.aCommands=[],e.commandPos=0,e.commandMaxLength=50,e.enterCommand=function(){(0===e.commandPos||e.aCommands[e.aCommands.length-e.commandPos]!==e.command)&&e.aCommands.push(e.command),e.commandPos=0,e.aCommands.length>e.commandMaxLength&&(e.aCommands=e.aCommands.slice(1)),t.send(e.command),e.command="",n(function(){e.$apply("command")},0,!1)};var o=function(t){e.historyChange(39-t.which)};e.historyChange=function(t){e.commandPos=Math.max(0,e.commandPos+t)%(e.aCommands.length+1),e.command=e.commandPos?e.aCommands[e.aCommands.length-e.commandPos]:"",n(function(){e.$apply("command")},0,!1)},e.keyDown=function(t){var n=t.keyCode?t.keyCode:t.which;switch(n){case 13:t.preventDefault(),e.enterCommand();break;case 27:case 33:case 34:r.keyDown(t);break;case 38:case 40:t.shiftKey?(t.preventDefault(),o(t)):(t.preventDefault(),r.keyDown(t));break;case 9:t.preventDefault(),r.keyDown(t);break;default:""===e.command&&(n>=48&&57>=n||-1!==$.inArray(n,[192,37,39,187,189]))&&(t.preventDefault(),r.keyDown(t))}}}]),angular.module("clientApp").directive("commandBar",function(){return{templateUrl:"templates/commandBar.tpl.html",restrict:"E",replace:!0,scope:!1,link:function(e,t){var n=function(e){o||-1!==$.inArray(e.which,[0,16,17,18,91,93])||e.ctrlKey||e.metaKey||-1!==$.inArray(document.activeElement.tagName.toLowerCase(),["input","textarea"])||(r.focus(),t.trigger(e))};t.on("keydown",function(t){e.keyDown(t)});var r=t.find("input").eq(0).focus(),o=!0;r.bind("blur",function(){o=!1}),r.bind("focus",function(){o=!0}),$(window).on("keydown",n),e.$on("$destroy",function(){$(window).off("keydown",n)})}}}),angular.module("clientApp").controller("CommandButtonsCtrl",["$scope","buttons","telnet","keypress",function(e,t,n,r){e.buttons=t;var o=r.$scope.$on(r.events.keydown,function(t,n){var o=r.getEventKey(n),i=-1;switch(o){case"minus":i=10;break;case"equal":i=11;break;case 0:i=9;break;default:"number"==typeof o&&(i=o-1)}-1!==i&&e.clickButton(i)});e.$on("$destroy",function(){o()}),e.clickButton=function(e){t.$scope.aActiveButtons.length>e&&t.$scope.aActiveButtons[e].command.length&&n.send(t.$scope.aActiveButtons[e].command),t.resetButtons()}}]),angular.module("clientApp").factory("autoscan",["$rootScope","telnet","$timeout","playerStatus",function(e,t,n,r){var o=e.$new();o.adjacentRooms={};var i=/^(\[Exits:|You see nothing in the vicinity\.)/,a=/,\s+(?=a|an|the|two|three|four|five|six|seven|eight|nine|ten|[A-Z]\S+)/,s=/^\s+(?=a|an|the|two|three|four|five|six|seven|eight|nine|ten|[A-Z]\S+)/,u={n:"north",e:"east",s:"south",w:"west",u:"up",d:"down"},c=!1,l=!1,f={},p="";t.$scope.$on(t.$scope.telnetEvents.parseLine,function(e,t){t.match(i)&&(c=!0,f={});var n=t.match(/^\s*\[?(Here|east|west|north|south|up|down)]?\s*:\s*(.*)$/);n?(c=!0,l=!0,p=n[1].toLowerCase(),f[p]=n[2]):l&&t.match(s)?f[p]+=t:l=!1}),t.$scope.$on(t.$scope.telnetEvents.parsePrompt,function(e,t){if(c){for(var i in f)if("darkness"===f[i])f[i]={type:"dark",buttons:[{label:"refresh light",command:"refreshLight"}]};else{f[i]=f[i].replace(/^\s*/,"").split(a);for(var s=f[i].length-1;s>=0;s--){var p={label:f[i][s].toLowerCase()},h=p.label.replace(/^\s*([^A-Z]\S*)?\s+/,"").replace(/(ves|ies|es|s)\b/g,"").replace(/\s+(the|\w|\w\w)(?=\s+)/g,"").replace(/[^a-zA-Z- ]+/g,"").split(" ").join(".");"here"===i?r.$scope.party.hasOwnProperty(f[i][s])?p=null:p.command="kill "+h:p.command=i+" & "+"kill "+h,null!==p?f[i][s]=p:f[i].splice(s,1)}f[i]=f[i].length?{type:"mobs",buttons:f[i]}:{type:"empty",buttons:[]}}if("none"!==t.exits&&"??"!==t.exits)for(var m in t.exits){var g=t.exits[m].toLowerCase(),v=u[g];f.hasOwnProperty(u[g])||(f[u[g]]=g!==t.exits[m]?{type:"empty",buttons:[]}:{type:"locked",buttons:[{label:"open "+v,command:"open "+v+" & scan"},{label:"unlock "+v,command:"unlock "+v+" & scan"},{label:"knock "+v,command:"knock "+v+" & scan"},{label:"pull lever",command:"pull lever & scan"},{label:"pound gate",command:"pound gate & scan"},{label:"move rubble",command:"move rubble & scan"},{label:"open door",command:"open door & scan"},{label:"unlock door",command:"unlock door & scan"},{label:"knock door",command:"knock door & scan"}]})}o.adjacentRooms=f,f={},l=!1,c=!1,n(function(){o.$broadcast(d.events.room_changed)},0,!0)}});var d={events:{room_changed:"AUTOSCAN_ROOM_CHANGE_DETECTED"},directionExists:function(e){return o.adjacentRooms.hasOwnProperty(e)},hasButtons:function(e){return d.directionExists(e)&&o.adjacentRooms[e].buttons.length>0},getButtons:function(e){return d.directionExists(e)?o.adjacentRooms[e].buttons:[]},$scope:o};return d}]),angular.module("clientApp").factory("keypress",["$rootScope",function(e){var t=e.$new(),n={keydown:"UNHANDLED_KEY_DOWN"};return{keyDown:function(e){t.$broadcast(n.keydown,e)},getEventKey:function(e){var t=e.which;switch(t){case 9:return"tab";case 13:return"enter";case 27:return"esc";case 32:return"space";case 33:return"pageup";case 34:return"pagedown";case 37:return"left";case 38:return"up";case 39:return"right";case 40:return"down";case 192:return"tilde";case 187:return"equal";case 189:return"minus"}return t>=48&&57>=t?t-48:"unknown"},$scope:t,events:n}}]),angular.module("clientApp").factory("buttons",["$rootScope","autoscan","profile","$timeout",function(e,t,n,r){var o=e.$new(),i=function(){r(function(){o.$apply("aActiveButtons")},0,!1)},a={$scope:o,setDirectionButtons:function(e){var n=t.getButtons(e);n.length&&(o.aActiveButtons=a.padButtons(n),o.buttonSet=e,i())},resetButtons:function(){""!==o.buttonSet&&(o.aActiveButtons=a.padButtons(n.getButtons("default")),o.buttonSet="",i())},indexToKey:function(e){switch(e){case 9:return 0;case 10:return"-";case 11:return"=";default:return e+1}},padButtons:function(e){if(12>e.length)for(var t=e.length;12>t;t++)e.push({command:"",label:""});return e}};return o.aActiveButtons=a.padButtons(n.getButtons("default")),o.buttonSet="",a}]),angular.module("clientApp").controller("EditButtonsCtrl",["$scope","profile","$location","buttons",function(e,t,n,r){e.buttons=r,e.activeButtons=t.getButtons("default");var o=angular.copy(e.activeButtons);e.done=function(){n.path("/")},e.undo=function(){e.activeButtons=angular.copy(o)}}]),angular.module("clientApp").factory("profile",[function(){var e,t={buttons:{"default":[{label:"look",command:"look & scan"},{label:"skin corpse",command:"skin corpse"},{label:"score",command:"score"},{label:"inventory",command:"inventory"},{label:"drink water",command:"drink water"},{label:"eat food",command:"eat food"}]}},n={get:function(e){var n=$.jStorage.get(e);return n?JSON.parse(n):t[e]}},r={getButtons:function(t){return e.hasOwnProperty(t)?e[t]:[]},setButtons:function(t,n){e[t]=n},save:function(){$.jStorage.set("buttons",JSON.stringify(e))},load:function(){e=n.get("buttons")}};return r.load(),r}]),angular.module("clientApp").factory("playerStatus",["$rootScope","telnet","$q",function(e,t,n){var r=e.$new();r.events={fullPartyUpdate:"ALL_PARTY_INFO_UPDATED"},r.name="TFE",r.leader="",r.party={},r.self={hp:1,hpMax:1,e:1,eMax:1,mv:1,mvMax:1},t.$scope.$on(t.$scope.telnetEvents.parsePrompt,function(e,t){r.$apply(function(){r.self.hp=t.hp,r.self.e=t.e,r.self.mv=t.mv,r.self.xp=t.xp})}),t.$scope.$on(t.$scope.telnetEvents.parseLine,function(e,n){var o=n.match(/^Leader:\s*(.*)\s*$/);if(o){r.leader=o[1];var i={},a=t.$scope.$on(t.$scope.telnetEvents.parseLine,function(e,t){var n=t.match(/^\[\s+(\d+)\s+(\w+)\s+\S+\s+\]\s+(\S+)\s*(\d+)\/(\d+)\s+(\d+)\/(\d+)\s+(\d+)\/(\d+)\s+(\d+)\s*$/);if(n)i[n[3]]={incog:!1,level:parseInt(n[1],10),"class":n[2],hp:parseInt(n[4],10),hpMax:parseInt(n[5],10),e:parseInt(n[6],10),eMax:parseInt(n[7],10),mv:parseInt(n[8],10),mvMax:parseInt(n[9],10),xp:parseInt(n[10],10)};else{var r=t.match(/^\[\s*Incognito\s*\]\s+(\S+)\s+(.*)\s*$/);r&&(i[r[1]]={incog:!0,status:r[2]})}});t.onNextPrompt("",function(){a(),r.$apply(function(){r.party=i,i.hasOwnProperty(r.name)&&(r.self=i[r.name])}),r.$broadcast(r.events.fullPartyUpdate)})}});var o={$scope:r,findName:function(){var e=n.defer();return t.onNextPrompt("score",function(){var n="",o=t.$scope.$on(t.$scope.telnetEvents.parseLine,function(t,i){i.match(/^\s*-+\s*$/)&&(o(),r.$apply(function(){r.name=$.trim(n),e.resolve(r.name)})),n=i})}),e.promise},updateGroup:function(){var e=n.defer();return t.onNextPrompt("group",function(){var t=r.$on(r.events.fullPartyUpdate,function(){t(),e.resolve(r.party)})}),e.promise}};return o}]),angular.module("clientApp").factory("promptParser",function(){var e=/^(?: -- MORE -- )?<([^|]*\|)?(\d+)hp (\d+)e \[?(\d+)mv\]? (\d+)wm (\d+)xp (perfect|scratched|bruised|cut|wounded|badly wounded|nastily wounded|bleeding freely|covered in blood|leaking guts|mostly dead|\?\?)?\s?([NESWUDneswud]+|none|\?\?)\s?(perfect|scratched|bruised|cut|wounded|badly wounded|nastily wounded|bleeding freely|covered in blood|leaking guts|mostly dead)?>\s*$/,t="",n=null,r={parse:function(r){if(r===t)return n;var o=null,i=r.match(e);return null!==i&&(o={flags:i[1],hp:parseInt(i[2],10),e:parseInt(i[3],10),mv:parseInt(i[4],10),wm:parseInt(i[5],10),xp:parseInt(i[6],10),leaderState:i[7],exits:i[8],targetState:i[9]},t=r,n=o),o}};return r}),angular.module("clientApp").factory("map",["$rootScope","telnet","$location",function(e,t,n){var r=e.$new();r.aMap=["              *              ","                             ","                             ","                             ","                             ","                             ","                             ","                             ","                             ","                             ","                             ","                             ","                             "],r.posX=14,r.posY=0,r.aMove=[],r.oCurrentMove={direction:"",type:"exit"},t.$scope.$on(t.$scope.telnetEvents.parseLine,function(e,o){if("You survey the area, then consult your atlas:"===o){var i=[],s=t.$scope.$on(t.$scope.telnetEvents.parseLine,function(e,t){i.push(t)});t.onNextPrompt("",function(){for(s();""===$.trim(i[0]);)i.splice(0,1);for(var e=0;i.length>e;e+=2)if(i[e]=i[e].substring(0,29),i[e].match(/\|/)){console.log("padding map due to line "+e+" : "+i[e]),i.unshift("                                  ");break}for(;14>i.length;)i.push("                                  ");i=i.splice(0,13);for(var t=0;i.length>t;t++){29>i[t].length&&(i[t]=i[t]+"                                  "),i[t]=i[t].substring(0,29);var o=i[t].indexOf("*");-1!==o&&(r.posX=o,r.posY=t)}r.aMap=i,n.path("/map")})}else{var u=o.match(/(?:You|You follow)\s(\S+\s?\S*)\s(north|east|south|west|up|down)\.$/);u&&u[2]===r.oCurrentMove.direction&&a.moveStep()}});var o=function(e,t){return t>=0&&r.aMap.length>t&&e>=0&&r.aMap[t].length>e&&" "!==r.aMap[t][e]?r.aMap[t][e]:""},i=function(e,t){return""+e+","+(""+t)},a={getShortestPath:function(e,t){var n={},a=[],s=function(e,t,n,r){return{x:e,y:t,id:i(e,t),path:n,cost:r}},u=i(e,t),c=function(e,t){var n=e.slice(0);return n.push(t),n},l=function(e,t){return e.cost-t.cost},f=function(e,t,r){var a,u;switch(r){case"north":a=0,u=-1;break;case"south":a=0,u=1;break;case"east":a=1,u=0;break;case"west":a=-1,u=0}var l=t.x+a+a,f=t.y+u+u;if(!n.hasOwnProperty(i(l,f))){var p=o(l,f);if(""!==p){var d=o(t.x+a,t.y+u);switch(d){case"+":return e.push(s(l,f,c(t.path,{direction:r,type:"door"}),t.cost+11)),void 0;case"|":case"-":return e.push(s(l,f,c(t.path,{direction:r,type:"exit"}),t.cost+10)),void 0;case"":case" ":return;default:return e.push(s(l,f,c(t.path,{direction:r,type:"unknown"}),t.cost+13)),void 0}}}},p=function(e){var t=[];return f(t,e,"north"),f(t,e,"east"),f(t,e,"south"),f(t,e,"west"),t},d=function(e){for(var t=p(e),r={},o=0;t.length>o;o++)r[t[o].id]=!0;if(t.length){for(var i=0;a.length>i;i++)if(r.hasOwnProperty(a[i].id))for(var s=t.length-1;s>=0;s--)a[i].id===t[s].id&&(a[i].cost<t[s].cost&&(a[i]=t[s]),t.splice(s,1));for(var c=0;t.length>c;c++)a.push(t[c])}if(a.length){a.sort(l);var f=a.splice(0,1)[0];if(n[f.id]=f,f.id===u)return;d(f)}},h=s(r.posX,r.posY,[],0);return n[h.id]=h,d(h),n.hasOwnProperty(u)?n[u].path:[]},moveStep:function(){r.aMove.length?(r.oCurrentMove=r.aMove.splice(0,1)[0],a.move()):r.oCurrentMove.direction=""},move:function(){t.send(r.oCurrentMove.direction),n.path("/")}},s={$scope:r,reverseDirection:function(e){switch(e){case"north":return"south";case"east":return"west";case"south":return"north";case"west":return"east";case"up":return"down";case"down":return"up"}},moveTo:function(e,t){r.aMove=a.getShortestPath(e,t),r.aMove.length&&a.moveStep()}};return s}]),angular.module("clientApp").controller("MapViewCtrl",["$scope","map",function(e,t){e.map=t}]),angular.module("clientApp").directive("mapView",function(){var e=function(e){switch(e){case"O":case">":case"<":case"X":case"?":return"room";case"*":return"here"}},t=function(e){switch(e){case"-":return'<i class="icon-resize-horizontal"></i>';case"|":return'<i class="icon-resize-vertical"></i>';case"+":return"+";case"?":return"?";case">":return'<i class="icon-sort-up"></i>';case"<":return'<i class="icon-sort-down"></i>';case"X":return'<i class="icon-sort"></i>'}},n=function(n){for(var r=n.$scope.aMap,o=[],i=function(){var e=$(this).data();n.moveTo(parseInt(e.x,10),parseInt(e.y,10))},a=0;13>a;a++){var s=angular.element("<div>");s.addClass(a%2?"mapSpaceRow":"mapRoomRow");for(var u=0;29>u;u++){var c=e(r[a][u]),l=angular.element("<div>").append(t(r[a][u])).addClass(c).data("x",u).data("y",a).appendTo(s);"room"===c&&l.bind("click",i)}o.push(s)}return o};return{restrict:"A",replace:!1,controller:"MapViewCtrl",link:function(e,t){t.addClass("map"),t.append(n(e.map))}}});