"use strict";angular.module("clientApp",["templates-main","$strap.directives","ui.bootstrap.modal","ui.bootstrap.dropdownToggle"]).config(["$routeProvider","$locationProvider",function(e,t){t.html5Mode(!1),e.when("/",{templateUrl:"views/main.html"}).when("/about",{templateUrl:"views/about.html"}).when("/contact",{templateUrl:"views/contact.html"}).when("/config/buttons",{templateUrl:"views/editButtons.html"}).otherwise({redirectTo:"/"})}]),angular.module("clientApp").controller("MainCtrl",["$scope","$rootScope","$window","telnet","$timeout","profile","playerStatus",function(e,t,n,r,o,i,a){e.bIsDev="localhost"===$(location).attr("hostname"),t.telnet=r,t.playerStatus=a;var s=function(){var e=!1,r=t.windowOrientation;t.windowHeight!==n.innerHeight&&(t.windowHeight=n.innerHeight,e=!0),t.windowWidth!==n.innerWidth&&(t.windowWidth=n.innerWidth,e=!0),t.windowOrientation=t.windowHeight>t.windowWidth||940>t.windowWidth?"portrait":"landscape",r!==t.windowOrientation&&(e=!0),e&&o(function(){t.$digest()},0,!1)};angular.element(n).bind("resize",function(){s()}),s(),a.findName().then(function(){a.updateGroup()}),n.onbeforeunload=function(){return i.save(),!e.bIsDev&&r.$scope.bConnected?"You are currently connected to "+r.$scope.server:void 0};var u=8e3,c="theforestsedge.com";e.bIsDev&&(u=7e3,c="vault-thirteen.net",r.$scope.$on(r.$scope.telnetEvents.parsePrompt,function(e,t){t.match(/Choice:/)?r.send("Tester"):t.match(/Password:/)?r.silentSend("TesterPassword"):t.match(/Press <return> to continue./)?r.send(""):t.match(/Disconnect previous link?/)&&r.send("y")})),r.connect(c,u)}]),angular.module("clientApp").controller("ScanCtrl",["$scope","autoscan","buttons","keypress","telnet",function(e,t,n,r,o){var i=function(e){switch(e){case"up":return"north";case"tilde":return"here";case"down":return"south";case"left":return"west";case"right":return"east";case"pageup":return"up";case"pagedown":return"down";case"tab":return"refresh";case"esc":return"reset"}return""},a=r.$scope.$on(r.events.keydown,function(t,n){var o=r.getEventKey(n),a=i(o);""!==a&&e.directionClick(a)}),s=t.$scope.$on(t.events.room_changed,function(){n.resetButtons()});e.$on("$destroy",function(){a(),s()}),e.directionClick=function(e){"reset"===e?n.resetButtons():"refresh"===e?(n.resetButtons(),o.send("scan")):n.$scope.buttonSet!==e&&t.hasButtons(e)?n.$scope.buttonSet!==e&&n.setDirectionButtons(e):"here"!==e&&o.send(e)}}]),angular.module("clientApp").factory("telnet",["$rootScope","$timeout",function(e,t){var n=e.$new();n.outputBuffer="",n.bConnected=!1,n.maxScrollback=2e4,n.server="",n.port="",n.telnetEvents={parsePrompt:"TELNET_PARSE_PROMPT",parseBlock:"TELNET_PARSE_BLOCK",parseLine:"TELNET_PARSE_LINE",connect:"TELNET_CONNECT",disconnect:"TELNET_DISCONNECT",bufferUpdated:"TELNET_OUTPUT_BUFFER_UPDATE"};var r={};r.ECHO=1,r.LF=10,r.CR=13,r.ESC=27,r.WILL=251,r.WONT=252,r.DO=253,r.DONT=254,r.IAC=255;var o=new Websock,i=0,a="",s=1,u=0,c=!1,l=!1,f=/^(<[^>]*>|\s*Choice:|\s*Password:|--\s*MORE\s*--\s*<[^>]*>|\s*Press <return> to continue\.|\s*Disconnect previous link\?)\s*$/,d=function(e){l&&window.console&&console.log(e)},p=function(){for(var e="";u>0;)e+="</span>",u--;return e},h=function(e,t){return parseInt(e,10)-parseInt(t,10)},m=function(e){if(c?(n.outputBuffer+=e,c=!1):n.outputBuffer+="<br />"+e,n.outputBuffer.length>n.maxScrollback){var r=n.outputBuffer.indexOf("<block_marker />",n.outputBuffer.length-n.maxScrollback+Math.ceil(.2*n.maxScrollback));r>0&&(n.outputBuffer=n.outputBuffer.substr(r+16))}l&&d("buffer: "+e),t(function(){n.$apply("outputBuffer"),n.$broadcast(n.telnetEvents.bufferUpdated)},0,!1)},g=function(e){for(var t="",l="",g="",v=0;e.length>v;v++){var y=e[v];switch(i){case 0:y===r.IAC?i=1:y===r.ECHO?s=0===s?1:0:y===r.ESC?i=3:y===r.LF?(m(g),l.length>0&&(a+=l+"\n"),l="",g=""):y!==r.CR&&(l+=String.fromCharCode(y),g+=60===y?"&lt;":62===y?"&gt;":String.fromCharCode(y));break;case 1:i=y===r.DO?2:0;break;case 2:o.send([r.IAC,r.WONT,y]),i=0;break;case 3:if("["===String.fromCharCode(y)){t="",i=4;continue}"c"===String.fromCharCode(y)?(p(),n.outputBuffer="",n.$broadcast(n.telnetEvents.bufferUpdated)):"M"===String.fromCharCode(y)?d("[Scroll Up]"):"D"===String.fromCharCode(y)?d("[Scroll Down]"):"H"===String.fromCharCode(y)?d("[Set Tab]"):"8"===String.fromCharCode(y)?d("[Restore Cursor & Attrs]"):"7"===String.fromCharCode(y)?d("[Save Cursor & Attrs]"):")"===String.fromCharCode(y)?d("[Font Set G0]"):"("===String.fromCharCode(y)?d("[Font Set G1]"):d("[unknown escape code : "+y+"]"),i=0;break;case 4:if(y>=48&&57>=y||59===y)t+=String.fromCharCode(y);else if("m"===String.fromCharCode(y)){var $=0,b="",w=t.split(";");w.sort(h);for(var x=0;w.length>x;x++){var C=parseInt(w[x],10);0===C&&u>0&&(g+=p()),1===C&&($=8),(2===C||22===C)&&($=0),3===C&&(b+="italic "),4===C&&(b+="uline "),(5===C||6===C)&&(b+="blink "),7===C&&(b="fg8 bg1"),9===C&&(b+="strikethrough "),37>=C&&C>=30&&(b+="fg"+(C-29+$)),47>=C&&C>=40&&(b+="bg"+(C-39+$))}b.length>0&&(g+='<span class="'+b+'">',u++),i=0}else d("[ansi:"+t+String.fromCharCode(y)+"]"),i=0}}if(a.length>0){for(var S=a.split("\n"),k=0;S.length>k;k++){var T=S[k];""!==T&&n.$broadcast(n.telnetEvents.parseLine,T)}n.$broadcast(n.telnetEvents.parseBlock,a),a=""}""!==g&&(m(g+p()+"<block_marker />"),null!==l.match(f)?(n.$broadcast(n.telnetEvents.parsePrompt,l),c=!1):c=!0)};return o.on("message",function(){g(o.rQshiftBytes(o.rQlen()))}),o.on("open",function(){n.bConnected=!0,c=!1,m('<span class="cmd">Connected to '+n.server+":"+n.port+"</span>"),n.$broadcast(n.telnetEvents.connect)}),o.on("close",function(){n.bConnected=!1,c=!1,m('<span class="cmd">Disconnected...</span>'),n.$broadcast(n.telnetEvents.disconnect)}),o.on("error",function(){c=!1,m('<span class="cmd">Connection error occured...</span>')}),{send:function(e){c=!0,o.send_string(e+"\n"),s&&(""===e?m(""):m('<span class="cmd">'+e+"</span>")),l&&d("send: "+e)},silentSend:function(e){c=!0,o.send_string(e+"\n")},connect:function(e,t){"string"!=typeof e?(e=n.server,t=n.port):(n.server=e,n.port=t),t=t||n.port,o.open("ws://"+e+":"+t,["binary","base64"])},disconnect:function(){o.close()},setConsoleOutput:function(e){l=e===!0},$scope:n}}]),angular.module("clientApp").directive("scanDirection",["autoscan","buttons",function(e,t){var n=function(e){switch(e){case"north":return"arrow-up";case"up":return"caret-up";case"east":return"arrow-right";case"south":return"arrow-down";case"down":return"caret-down";case"west":return"arrow-left";case"here":return"bolt";case"refresh":return"refresh"}};return{restrict:"A",replace:!1,scope:!1,link:function(r,o,i){if(o.addClass("icon-"+n(i.scanDirection)),o.addClass("btn btn-block"),"refresh"!==i.scanDirection){var a=e.$scope.$watch("adjacentRooms."+i.scanDirection,function(e){void 0!==e?(o.removeClass("disabled muted btn-danger btn-info"),"mobs"===e.type?o.addClass("btn-danger"):("locked"===e.type||"dark"===e.type)&&o.addClass("btn-info")):(o.removeClass("btn-danger btn-info"),o.addClass("disabled muted"))},!0),s=t.$scope.$watch("buttonSet",function(e){e===i.scanDirection?o.addClass("selected"):o.removeClass("selected")});r.$on("$destroy",function(){a(),s()})}o.bind("click",function(){r.directionClick(i.scanDirection)})}}}]),angular.module("clientApp").directive("telnetSend",["telnet",function(e){return function(t,n,r){n.bind("click",function(){e.send(r.telnetSend)})}}]),angular.module("clientApp").directive("telnetStatus",["telnet",function(e){return{restrict:"A",replace:!1,link:function(t,n){var r=e.$scope.$watch("bConnected",function(t){t?n.removeClass("disconnected").addClass("connected").off("click",e.connect).on("click",e.disconnect):n.removeClass("connected").addClass("disconnected").off("click",e.disconnect).on("click",e.connect)});t.$on("$destroy",function(){r()})}}}]),angular.module("clientApp").directive("autoscroll",["telnet","$window",function(e,t){return{restrict:"A",scope:!1,link:function(n,r){var o=!0,i=function(){return Math.max(r[0].scrollHeight,r[0].clientHeight)-r[0].clientHeight},a=e.$scope.$on(e.$scope.telnetEvents.bufferUpdated,function(){o&&(r[0].scrollTop=i())}),s=function(){o=!0,r[0].scrollTop=i()},u=function(e){o===!1&&(13===e.which?s():32===e.which&&(e.preventDefault(),s()))};angular.element(t).bind("resize",s),angular.element(t).bind("keydown",u),n.$on("$destroy",function(){a(),angular.element(t).unbind("resize",s),angular.element(t).unbind("keydown",u)}),r.on("scroll",function(){o=i()!==r[0].scrollTop?!1:!0})}}}]),angular.module("clientApp").controller("CommandBarCtrl",["$scope","telnet","$timeout","keypress",function(e,t,n,r){e.command="",e.aCommands=[],e.commandPos=0,e.commandMaxLength=50,e.enterCommand=function(){(0===e.commandPos||e.aCommands[e.aCommands.length-e.commandPos]!==e.command)&&e.aCommands.push(e.command),e.commandPos=0,e.aCommands.length>e.commandMaxLength&&(e.aCommands=e.aCommands.slice(1)),t.send(e.command),e.command="",n(function(){e.$apply("command")},0,!1)};var o=function(t){e.historyChange(39-t.which)};e.historyChange=function(t){e.commandPos=Math.max(0,e.commandPos+t)%(e.aCommands.length+1),e.command=e.commandPos?e.aCommands[e.aCommands.length-e.commandPos]:"",n(function(){e.$apply("command")},0,!1)},e.keyDown=function(t){var n=t.keyCode?t.keyCode:t.which;switch(n){case 13:t.preventDefault(),e.enterCommand();break;case 27:case 33:case 34:r.keyDown(t);break;case 38:case 40:t.shiftKey?(t.preventDefault(),o(t)):(t.preventDefault(),r.keyDown(t));break;case 9:t.preventDefault(),r.keyDown(t);break;default:""===e.command&&(n>=48&&57>=n||-1!==$.inArray(n,[192,37,39,187,189]))&&(t.preventDefault(),r.keyDown(t))}}}]),angular.module("clientApp").directive("commandBar",function(){return{templateUrl:"templates/commandBar.tpl.html",restrict:"E",replace:!0,scope:!1,link:function(e,t){var n=function(e){o||-1!==$.inArray(e.which,[0,16,17,18,91,93])||e.ctrlKey||e.metaKey||-1!==$.inArray(document.activeElement.tagName.toLowerCase(),["input","textarea"])||(r.focus(),t.trigger(e))};t.on("keydown",function(t){e.keyDown(t)});var r=t.find("input").eq(0).focus(),o=!0;r.bind("blur",function(){o=!1}),r.bind("focus",function(){o=!0}),$(window).on("keydown",n),e.$on("$destroy",function(){$(window).off("keydown",n)})}}}),angular.module("clientApp").controller("CommandButtonsCtrl",["$scope","buttons","telnet","keypress",function(e,t,n,r){e.buttons=t;var o=r.$scope.$on(r.events.keydown,function(t,n){var o=r.getEventKey(n),i=-1;switch(o){case"minus":i=10;break;case"equal":i=11;break;case 0:i=9;break;default:"number"==typeof o&&(i=o-1)}-1!==i&&e.clickButton(i)});e.$on("$destroy",function(){o()}),e.clickButton=function(e){t.$scope.aActiveButtons.length>e&&t.$scope.aActiveButtons[e].command.length&&n.send(t.$scope.aActiveButtons[e].command),t.resetButtons()}}]),angular.module("clientApp").factory("autoscan",["$rootScope","telnet","$timeout",function(e,t,n){var r=e.$new();r.adjacentRooms={};var o=/^(\[Exits:|You see nothing in the vicinity\.)/,i=/,\s+(?=a|an|the|two|three|four|five|six|seven|eight|nine|ten|[A-Z]\S+)/,a=/^\s+(?=a|an|the|two|three|four|five|six|seven|eight|nine|ten|[A-Z]\S+)/,s={n:"north",e:"east",s:"south",w:"west",u:"up",d:"down"},u=!1,c=!1,l={},f="";t.$scope.$on(t.$scope.telnetEvents.parseLine,function(e,t){t.match(o)&&(u=!0,l={});var n=t.match(/^\s*\[?(Here|east|west|north|south|up|down)]?\s*:\s*(.*)$/);n?(u=!0,c=!0,f=n[1].toLowerCase(),l[f]=n[2]):c&&t.match(a)?l[f]+=t:c=!1}),t.$scope.$on(t.$scope.telnetEvents.parsePrompt,function(e,t){if(u){for(var o in l)if("darkness"===l[o])l[o]={type:"dark",buttons:[{label:"refresh light",command:"refreshLight"}]};else{l[o]=l[o].replace(/^\s*/,"").split(i);for(var a=0;l[o].length>a;a++){var f={label:l[o][a].toLowerCase()},p=f.label.replace(/^\s*([^A-Z]\S*)?\s+/,"").replace(/(ves|ies|es|s)\b/g,"").replace(/\s+(the|\w|\w\w)(?=\s+)/g,"").replace(/[^a-zA-Z- ]+/g,"").split(" ").join(".");f.command=("here"!==o?o+" & ":"")+"kill "+p,l[o][a]=f}l[o]={type:"mobs",buttons:l[o]}}var h=t.match(/<.*\s([NESWUD]*)>/i);if(h)for(var m in h[1]){var g=h[1][m].toLowerCase(),v=s[g];l.hasOwnProperty(s[g])||(l[s[g]]=g!==h[1][m]?{type:"empty",buttons:[]}:{type:"locked",buttons:[{label:"open "+v,command:"open "+v+" & scan"},{label:"unlock "+v,command:"unlock "+v+" & scan"},{label:"knock "+v,command:"knock "+v+" & scan"},{label:"pull lever",command:"pull lever & scan"},{label:"pound gate",command:"pound gate & scan"},{label:"move rubble",command:"move rubble & scan"},{label:"open door",command:"open door & scan"},{label:"unlock door",command:"unlock door & scan"},{label:"knock door",command:"knock door & scan"}]})}r.adjacentRooms=l,l={},c=!1,u=!1,n(function(){r.$broadcast(d.events.room_changed)},0,!0)}});var d={events:{room_changed:"AUTOSCAN_ROOM_CHANGE_DETECTED"},directionExists:function(e){return r.adjacentRooms.hasOwnProperty(e)},hasButtons:function(e){return d.directionExists(e)&&r.adjacentRooms[e].buttons.length>0},getButtons:function(e){return d.directionExists(e)?r.adjacentRooms[e].buttons:[]},$scope:r};return d}]),angular.module("clientApp").factory("keypress",["$rootScope",function(e){var t=e.$new(),n={keydown:"UNHANDLED_KEY_DOWN"};return{keyDown:function(e){t.$broadcast(n.keydown,e)},getEventKey:function(e){var t=e.which;switch(t){case 9:return"tab";case 13:return"enter";case 27:return"esc";case 32:return"space";case 33:return"pageup";case 34:return"pagedown";case 37:return"left";case 38:return"up";case 39:return"right";case 40:return"down";case 192:return"tilde";case 187:return"equal";case 189:return"minus"}return t>=48&&57>=t?t-48:"unknown"},$scope:t,events:n}}]),angular.module("clientApp").factory("buttons",["$rootScope","autoscan","profile","$timeout",function(e,t,n,r){var o=e.$new(),i=function(){r(function(){o.$apply("aActiveButtons")},0,!1)},a={$scope:o,setDirectionButtons:function(e){var n=t.getButtons(e);n.length&&(o.aActiveButtons=a.padButtons(n),o.buttonSet=e,i())},resetButtons:function(){""!==o.buttonSet&&(o.aActiveButtons=a.padButtons(n.getButtons("default")),o.buttonSet="",i())},indexToKey:function(e){switch(e){case 9:return 0;case 10:return"-";case 11:return"=";default:return e+1}},padButtons:function(e){if(12>e.length)for(var t=e.length;12>t;t++)e.push({command:"",label:""});return e}};return o.aActiveButtons=a.padButtons(n.getButtons("default")),o.buttonSet="",a}]),angular.module("clientApp").controller("EditButtonsCtrl",["$scope","profile","$location","buttons",function(e,t,n,r){e.buttons=r,e.activeButtons=t.getButtons("default");var o=angular.copy(e.activeButtons);e.done=function(){n.path("/")},e.undo=function(){e.activeButtons=angular.copy(o)}}]),angular.module("clientApp").factory("profile",[function(){var e,t={buttons:{"default":[{label:"look",command:"look & scan"},{label:"skin corpse",command:"skin corpse"},{label:"score",command:"score"},{label:"inventory",command:"inventory"},{label:"drink water",command:"drink water"},{label:"eat food",command:"eat food"}]}},n={get:function(e){var n=$.jStorage.get(e);return n?JSON.parse(n):t[e]}},r={getButtons:function(t){return e.hasOwnProperty(t)?e[t]:[]},setButtons:function(t,n){e[t]=n},save:function(){$.jStorage.set("buttons",JSON.stringify(e))},load:function(){e=n.get("buttons")}};return r.load(),r}]),angular.module("clientApp").factory("playerStatus",["$rootScope","telnet","$q",function(e,t,n){var r=e.$new();r.events={fullPartyUpdate:"ALL_PARTY_INFO_UPDATED"};var o=/^(?: -- MORE -- )?<([^|]*\|)?(\d+)hp (\d+)e \[?(\d+)mv\]? (\d+)wm (\d+)xp (perfect|scratched|bruised|cut|wounded|badly wounded|nastily wounded|bleeding freely|covered in blood|leaking guts|mostly dead|\?\?)?\s?([NESWUDneswud]+|none)\s?(perfect|scratched|bruised|cut|wounded|badly wounded|nastily wounded|bleeding freely|covered in blood|leaking guts|mostly dead)?>\s*$/;r.name="TFE",r.leader="",r.party={},r.self={hp:1,hpMax:1,e:1,eMax:1,mv:1,mvMax:1};var i=function(e,n,r){var o=t.$scope.$on(t.$scope.telnetEvents.parsePrompt,function(i,a){a.match(e)&&(o(),void 0!==r&&r(),""!==n&&t.send(n))})};t.$scope.$on(t.$scope.telnetEvents.parsePrompt,function(e,t){var n=t.match(o);n&&r.$apply(function(){r.self.hp=parseInt(n[2],10),r.self.e=parseInt(n[3],10),r.self.mv=parseInt(n[4],10),r.self.xp=parseInt(n[6],10)})}),t.$scope.$on(t.$scope.telnetEvents.parseLine,function(e,n){var a=n.match(/^Leader:\s*(.*)\s*$/);if(a){r.leader=a[1];var s={},u=t.$scope.$on(t.$scope.telnetEvents.parseLine,function(e,t){var n=t.match(/^\[\s+(\d+)\s+(\w+)\s+\S+\s+\]\s+(\S+)\s*(\d+)\/(\d+)\s+(\d+)\/(\d+)\s+(\d+)\/(\d+)\s+(\d+)\s*$/);if(n)s[n[3]]={incog:!1,level:parseInt(n[1],10),"class":n[2],hp:parseInt(n[4],10),hpMax:parseInt(n[5],10),e:parseInt(n[6],10),eMax:parseInt(n[7],10),mv:parseInt(n[8],10),mvMax:parseInt(n[9],10),xp:parseInt(n[10],10)};else{var r=t.match(/^\[\s*Incognito\s*\]\s+(\S+)\s+(.*)\s*$/);r&&(s[r[1]]={incog:!0,status:r[2]})}});i(o,"",function(){u(),r.$apply(function(){r.party=s,s.hasOwnProperty(r.name)&&(r.self=s[r.name])}),r.$broadcast(r.events.fullPartyUpdate)})}});var a={$scope:r,findName:function(){var e=n.defer();return i(o,"score",function(){var n="",o=t.$scope.$on(t.$scope.telnetEvents.parseLine,function(t,i){i.match(/^\s*-+\s*$/)&&(o(),r.$apply(function(){r.name=$.trim(n),e.resolve(r.name)})),""!==$.trim(i)&&(n=i)})}),e.promise},updateGroup:function(){var e=n.defer();return i(o,"group",function(){var t=r.$on(r.events.fullPartyUpdate,function(){t(),e.resolve(r.party)})}),e.promise}};return a}]);